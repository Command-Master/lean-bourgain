\chapter{Incidence}
\label{chap:inc}

\begin{definition}
    \label{ST_C}
    \lean{ST_C}
    \leanok
    \uses{ST_C2}
    $C = C_2 + 1$
\end{definition}

\begin{definition}
    \lean{ST_prime_field_eps}
    \leanok
    $\stpfone(\beta) = \stpftwo(\beta) / 3$
\end{definition}

\begin{theorem}
    \label{ST_prime_field}
    \lean{ST_prime_field}
    \leanok
    Let there be a set $P$ of points and a set $L$ of lines over a prime field, 
    with $|P| \leq n, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$.
    Then the number of intersections is at most $ C n^{\frac32 - \stpfone(\beta)} $.
\end{theorem}

\begin{proof}
    \leanok
    \uses{ST_prime_field_aux₂'}
    We reduce this to \ref{ST_prime_field_aux₂'}, by removing all points contained in at most
    $n^{\frac12 - \stpfone(\beta)}$ lines. This removes at most $n^{\frac32 - \stpfone(\beta)}$
    points, which is corrected for with $C = C_2 + 1$.
\end{proof}

\begin{definition}
    \label{ST_C2}
    \lean{ST_C₂}
    \leanok
    $C_2 = \sqrt{2(C_3 + \frac{\sqrt2}4)}$
\end{definition}

\begin{theorem}
    \label{ST_prime_field_aux₂'}
    \lean{ST_prime_field_aux₂'}
    \leanok
    Let there be a set $P$ of points and a set $L$ of lines over a prime field, 
    with $|P| \leq n, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$,
    and each point intersecting with at least $n^{\frac12 - \stpfone(\beta)}$ lines.
    Then the number of intersections is at most $C_2 n^{\frac32 - \stpfone(\beta)}$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{ST_prime_field_aux, CS_UB}
    We reduce this to \ref{ST_prime_field_aux}, by removing all points contained in more than 
    $4 n^{\frac12 + \stpfone(\beta)}$ lines. There can be at most
    $n^{1 - 2 \stpfone(\beta)} \frac{\sqrt2}4$ such points, by \ref{CS_UB}.
    Therefore, there are still many remaining points, and because each point has at least
    $n^{\frac12 - \stpfone(\beta)}$ lines there are still many intersections.
\end{proof}

\begin{theorem}
    \label{ST_prime_field_aux}
    \lean{ST_prime_field_aux}
    \leanok
    Let there be a set $P$ of points and a set $L$ of lines over a prime field, 
    with $|P| \leq n, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$,
    and each point contained in at least $n^{\frac12 - \stpfone(\beta)}$ lines
    and at most $4 n^{\frac12 + \stpfone(\beta)}$.
    Then the number of intersections is at most $C_3 n^{\frac32 - \stpftwo(\beta)}$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{claim_342, ST_prime_field_proj}
    We use \ref{claim_342} to claim that there exist two points, $a, b$ such that for a large number of 
    points they are both on a line from $a$ and a line from $b$.
    We only keep those, and because all points are contained in $n^{\frac12 - \stpfone(\beta)}$ lines there are still many intersections.
    Then we remove all points on the line between $a$ and $b$. Because all lines, expect maybe one, intersect at most one such point,
    this step doesn't remove many intersections.
    Now we can apply \ref{ST_prime_field_proj}.
\end{proof}

\begin{theorem}
    \label{ST_grid}
    \lean{ST_grid}
    \leanok
    Let there be two sets $A, B$ and a set $L$ of lines over a prime field, 
    with $|A| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |B| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$.
    Then the number of intersections is at most $C' n^{\frac32 - \sgone(\beta)}$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{ST_grid_aux}
    We reduce to \ref{ST_grid_aux} by removing all lines which contain too few points.
\end{proof}

\begin{theorem}
    \label{ST_grid_aux}
    \lean{ST_grid_aux}
    \leanok
    Let there be two sets $A, B$ and a set $L$ of lines over a prime field, 
    with $|A| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |B| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$.
    Additionally, suppose there are at least $n^{\frac12 - \sgone(\beta)}$ points on each line.
    Then the number of intersections is at most $C'_2 n^{\frac32 - \sgone(\beta)}$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{ST_grid_aux₂}
    We now remove all horizontal lines, to reduce to \ref{ST_grid_aux₂}.
    This doesn't remove many intersections because each point can intersect at most one horizontal line.
\end{proof}

\begin{theorem}
    \label{ST_grid_aux₂}
    \lean{ST_grid_aux₂}
    \leanok
    Let there be two sets $A, B$ and a set $L$ of non-horizontal lines over a prime field, 
    with $|A| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |B| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$.
    Additionally, suppose there are at least $n^{\frac12 - \sgone(\beta)}$ points on each line.
    Then the number of intersections is at most $C'_2 n^{\frac32 - \sgone(\beta)}$.
\end{theorem}

\begin{proof}
    \leanok
    \uses{claim_342_grid, ST_grid_final}
    We apply \ref{claim_342_grid} to get two values $b_1, b_2 \in B$ such that many lines pass
    through these rows. Because there are many points on each line, only keeping those still gives many
    incidences. Now, a line can be described as two points $a_1, a_2$, and the line would be the line passing through
    $(a_1, b_1), (a_2, b_2)$. Suppose it passes through a given point $(a, b)$. This gives
    $a = \frac{b_2 - b}{b_2 - b_1} a_1 + \frac{b - b_1}{b_2 - b_1} a_2$, so
    $\frac{b_2 - b}{b_2 - b_1} a_1 + \frac{b - b_1}{b_2 - b_1} a_2 \in A$. Equivalently, there are many ($N^{3/2 - \epsilon}$) triplets
    $(b, a_1, a_2) \in B \times A \times A$ such that $\frac{b_2 - b}{b_2 - b_1} a_1 + \frac{b - b_1}{b_2 - b_1} a_2 \in A$.
    This implies that there must be many ($N^{1/2 - \epsilon}$) values of $b$ such that there is a large number of pairs
    $(a_1, a_2)$ with this property. Now we can only keep those, remove $b_1, b_2$, and apply \ref{ST_grid_final}
\end{proof}

\begin{theorem}
    \label{ST_grid_final}
    \lean{ST_grid_final}
    \leanok
    Let there be two sets $A, B$ and a set $L$ of non-horizontal lines over a prime field, 
    with $|A| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |B| \leq 4n^{\frac12 + 2*\stpfone(\beta)}, |L| \leq n$ and $p^\beta \leq n \leq p^{2 - \beta}$.
    Suppose there are at least $n^{\frac12 - \sgone(\beta)}$ points on each line, and lastly,
    suppose there are two values $b_1, b_2 \notin B$, .
    Then $|B|$ is at most $C'_5 n^{1/2 - \sgtwo(\beta) - \sgone(\beta) - 4 \stpfone(\beta)}$.
\end{theorem}

\begin{proof}
    \leanok
    TODO
\end{proof}